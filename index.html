<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Identificatore Colori da Immagine</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  }

  #image-container {
    width: 75%;
    max-height: calc(100vh - 80px);
    border: 1px solid #ccc;
    border-radius: 5px;
    padding: 0.5rem;
    overflow: auto;
    position: relative;
    background: #fafafa;
  }

  #image-canvas {
    border: 1px solid #ddd;
    border-radius: 3px;
    cursor: crosshair;
    display: block;
    width: 100%;
    height: auto; /* Mantiene proporzioni immagine */
    user-select: none;
  }

  #color-info {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  #color-preview {
    width: 50px;
    height: 50px;
    border: 1px solid #000;
    border-radius: 5px;
  }

  .slider-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .slider-group label {
    min-width: 25px;
  }

  input[type="range"] {
    width: 150px;
  }

  .slider-value {
    min-width: 30px;
    text-align: right;
    font-family: monospace;
  }
</style>
</head>
<body>

<h2>Identificatore Colori da Immagine</h2>

<input type="file" id="image-input" accept="image/*" />

<div id="image-container">
  <canvas id="image-canvas"></canvas>
</div>

<div id="color-info">
  <div id="color-preview"></div>

  <div>
    <div class="slider-group">
      <label for="r-slider">R</label>
      <input type="range" id="r-slider" min="0" max="255" value="0" disabled />
      <div id="r-value" class="slider-value">0</div>
    </div>
    <div class="slider-group">
      <label for="g-slider">G</label>
      <input type="range" id="g-slider" min="0" max="255" value="0" disabled />
      <div id="g-value" class="slider-value">0</div>
    </div>
    <div class="slider-group">
      <label for="b-slider">B</label>
      <input type="range" id="b-slider" min="0" max="255" value="0" disabled />
      <div id="b-value" class="slider-value">0</div>
    </div>
  </div>
</div>

<script>
  const imageInput = document.getElementById('image-input');
  const canvas = document.getElementById('image-canvas');
  const ctx = canvas.getContext('2d');

  const colorPreview = document.getElementById('color-preview');
  const rSlider = document.getElementById('r-slider');
  const gSlider = document.getElementById('g-slider');
  const bSlider = document.getElementById('b-slider');

  const rValue = document.getElementById('r-value');
  const gValue = document.getElementById('g-value');
  const bValue = document.getElementById('b-value');

  const container = document.getElementById('image-container');

  let imgLoaded = false;

  imageInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(event) {
      const img = new Image();
      img.onload = function() {
        // Imposto dimensioni canvas a quelle reali immagine
        canvas.width = img.width;
        canvas.height = img.height;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);

        imgLoaded = true;

        // Abilito slider (che saranno sincronizzati al click)
        rSlider.disabled = false;
        gSlider.disabled = false;
        bSlider.disabled = false;
      };
      img.src = event.target.result;
    };
    reader.readAsDataURL(file);
  });

  function getCursorPos(evt) {
    let clientX, clientY;
    if (evt.touches && evt.touches.length) {
      clientX = evt.touches[0].clientX;
      clientY = evt.touches[0].clientY;
    } else {
      clientX = evt.clientX;
      clientY = evt.clientY;
    }

    const rect = canvas.getBoundingClientRect();

    // Scroll del contenitore (utile se scrollato)
    const scrollLeft = container.scrollLeft;
    const scrollTop = container.scrollTop;

    // Posizione relativa nel canvas (CSS)
    const xInCanvas = clientX - rect.left + scrollLeft;
    const yInCanvas = clientY - rect.top + scrollTop;

    // Scala per convertire in coordinate bitmap reali
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;

    let x = Math.floor(xInCanvas * scaleX);
    let y = Math.floor(yInCanvas * scaleY);

    // Clamp allâ€™interno canvas
    x = Math.min(Math.max(x, 0), canvas.width - 1);
    y = Math.min(Math.max(y, 0), canvas.height - 1);

    return { x, y, clientX, clientY };
  }

  function updateColorPreview(r, g, b) {
    const rgb = `rgb(${r},${g},${b})`;
    colorPreview.style.backgroundColor = rgb;

    rSlider.value = r;
    gSlider.value = g;
    bSlider.value = b;

    rValue.textContent = r;
    gValue.textContent = g;
    bValue.textContent = b;
  }

  function pickColor(evt) {
    if (!imgLoaded) return;

    const pos = getCursorPos(evt);
    const pixel = ctx.getImageData(pos.x, pos.y, 1, 1).data;
    updateColorPreview(pixel[0], pixel[1], pixel[2]);
  }

  // Evento mouse + touch per pick colore
  canvas.addEventListener('mousemove', pickColor);
  canvas.addEventListener('touchmove', (e) => {
    e.preventDefault(); // evita scroll pagina mentre si sceglie colore
    pickColor(e);
  }, { passive: false });

</script>
</body>
</html>
