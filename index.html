<script>
  const imageInput = document.getElementById('image-input');
  const canvas = document.getElementById('image-canvas');
  const ctx = canvas.getContext('2d');
  const colorList = document.getElementById('color-list');
  const addedColors = new Set();
  const hoverPreview = document.getElementById('hover-preview');
  const hoverSwatch = hoverPreview.querySelector('.swatch');
  const hoverHex = hoverPreview.querySelector('span');

  // Funzione per ottenere coordinate precise (mouse o touch)
  function getEventCoordinates(event) {
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;

    let clientX, clientY;

    if (event.touches && event.touches.length > 0) {
      clientX = event.touches[0].clientX;
      clientY = event.touches[0].clientY;
    } else {
      clientX = event.clientX;
      clientY = event.clientY;
    }

    const x = Math.floor((clientX - rect.left) * scaleX);
    const y = Math.floor((clientY - rect.top) * scaleY);
    return { x, y, clientX, clientY };
  }

  imageInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (event) {
      const img = new Image();
      img.onload = function () {
        // Retina scaling
        const ratio = window.devicePixelRatio || 1;
        canvas.width = img.width * ratio;
        canvas.height = img.height * ratio;
        canvas.style.width = img.width + 'px';
        canvas.style.height = img.height + 'px';
        ctx.setTransform(1, 0, 0, 1, 0, 0); // reset
        ctx.scale(ratio, ratio);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);
      };
      img.src = event.target.result;
    };
    reader.readAsDataURL(file);
  });

  function getHexAtEvent(event) {
    const { x, y } = getEventCoordinates(event);
    const pixel = ctx.getImageData(x, y, 1, 1).data;
    return rgbToHex(pixel[0], pixel[1], pixel[2]);
  }

  canvas.addEventListener('mousemove', (e) => {
    const { clientX, clientY } = e;
    const hex = getHexAtEvent(e);
    hoverPreview.style.display = 'flex';
    hoverPreview.style.left = `${clientX + 10}px`;
    hoverPreview.style.top = `${clientY + 10}px`;
    hoverSwatch.style.backgroundColor = hex;
    hoverHex.textContent = hex;
  });

  canvas.addEventListener('mouseleave', () => {
    hoverPreview.style.display = 'none';
  });

  canvas.addEventListener('click', (e) => {
    const hex = getHexAtEvent(e);
    addColorBox(hex);
  });

  canvas.addEventListener('touchstart', (e) => {
    const hex = getHexAtEvent(e);
    addColorBox(hex);
  });

  function rgbToHex(r, g, b) {
    return "#" + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');
  }

  function addColorBox(hex) {
    if (addedColors.has(hex)) return;
    addedColors.add(hex);

    const div = document.createElement('div');
    div.className = 'color-box';
    div.innerHTML = `
      <div class="swatch" style="background: ${hex}"></div>
      <span>${hex}</span>
      <span class="remove-btn" title="Rimuovi colore">&times;</span>
    `;

    div.querySelector('.remove-btn').addEventListener('click', () => {
      addedColors.delete(hex);
      colorList.removeChild(div);
    });

    colorList.appendChild(div);
  }

  // Custom RGB sliders
  const redSlider = document.getElementById('red');
  const greenSlider = document.getElementById('green');
  const blueSlider = document.getElementById('blue');
  const customSwatch = document.getElementById('custom-swatch');
  const customHex = document.getElementById('custom-hex');
  const addCustomBtn = document.getElementById('add-custom-color');
  const valRed = document.getElementById('val-red');
  const valGreen = document.getElementById('val-green');
  const valBlue = document.getElementById('val-blue');

  function updateCustomColor() {
    const r = parseInt(redSlider.value);
    const g = parseInt(greenSlider.value);
    const b = parseInt(blueSlider.value);
    valRed.textContent = r;
    valGreen.textContent = g;
    valBlue.textContent = b;
    const hex = rgbToHex(r, g, b);
    customSwatch.style.backgroundColor = hex;
    customHex.textContent = hex;
  }

  redSlider.addEventListener('input', updateCustomColor);
  greenSlider.addEventListener('input', updateCustomColor);
  blueSlider.addEventListener('input', updateCustomColor);
  addCustomBtn.addEventListener('click', () => {
    const hex = customHex.textContent;
    addColorBox(hex);
  });

  updateCustomColor();

  // Export TXT
  const exportBtn = document.getElementById('export-btn');
  exportBtn.addEventListener('click', () => {
    if (addedColors.size === 0) {
      alert("Nessun colore selezionato da esportare.");
      return;
    }
    const content = Array.from(addedColors).join('\n');
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'colori_selezionati.txt';
    a.click();
    URL.revokeObjectURL(url);
  });
</script>
