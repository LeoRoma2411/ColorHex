<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Identificatore Colori</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 10px;
    background: #f0f0f0;
  }
  .container {
    max-width: 600px;
    margin: auto;
    background: white;
    padding: 10px;
    border-radius: 6px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }
  canvas {
    width: 100%;
    height: auto;
    border: 1px solid #ccc;
    touch-action: none; /* per gestire touch senza zoom etc */
  }
  #preview {
    position: absolute;
    pointer-events: none;
    border-radius: 4px;
    padding: 6px 10px;
    font-size: 14px;
    color: white;
    background-color: rgba(0,0,0,0.7);
    transform: translate(10px, 10px);
    display: none;
    user-select: none;
    z-index: 10;
  }
  .selected-colors {
    margin-top: 15px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }
  .color-box {
    width: 30px;
    height: 30px;
    border-radius: 4px;
    border: 1px solid #ccc;
  }
  .sliders {
    margin-top: 20px;
  }
  .slider-group {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
  }
  .slider-group label {
    width: 40px;
  }
  .slider-group input[type=range] {
    flex-grow: 1;
    margin: 0 10px;
  }
  .slider-color-box {
    width: 30px;
    height: 30px;
    border-radius: 4px;
    border: 1px solid #ccc;
  }
  @media (hover: none) and (pointer: coarse) {
    /* Mobile styles to keep consistent */
    #preview {
      font-size: 12px;
      padding: 4px 7px;
    }
  }
</style>
</head>
<body>
<div class="container">
  <canvas id="canvas" width="600" height="400"></canvas>
  <div id="preview"></div>

  <div class="selected-colors" id="selectedColors"></div>

  <div class="sliders">
    <div class="slider-group">
      <label for="rRange">R</label>
      <input type="range" id="rRange" min="0" max="255" value="128" />
      <div id="rColorBox" class="slider-color-box"></div>
    </div>
    <div class="slider-group">
      <label for="gRange">G</label>
      <input type="range" id="gRange" min="0" max="255" value="128" />
      <div id="gColorBox" class="slider-color-box"></div>
    </div>
    <div class="slider-group">
      <label for="bRange">B</label>
      <input type="range" id="bRange" min="0" max="255" value="128" />
      <div id="bColorBox" class="slider-color-box"></div>
    </div>
  </div>
</div>

<script>
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  const preview = document.getElementById("preview");
  const selectedColorsContainer = document.getElementById("selectedColors");

  // Sliders and their color boxes
  const rRange = document.getElementById("rRange");
  const gRange = document.getElementById("gRange");
  const bRange = document.getElementById("bRange");
  const rColorBox = document.getElementById("rColorBox");
  const gColorBox = document.getElementById("gColorBox");
  const bColorBox = document.getElementById("bColorBox");

  // Disegno immagine di esempio sul canvas (puoi sostituire con una tua immagine)
  const img = new Image();
  img.crossOrigin = "anonymous";
  img.src = "https://upload.wikimedia.org/wikipedia/commons/thumb/3/3f/Fronalpstock_big.jpg/600px-Fronalpstock_big.jpg";
  img.onload = () => {
    // Disegno lâ€™immagine adattandola a dimensione canvas
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  };

  // Funzione per ottenere coordinate esatte nel canvas (indipendente da device e scala)
  function getCanvasCoordinates(clientX, clientY) {
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    return {
      x: Math.floor((clientX - rect.left) * scaleX),
      y: Math.floor((clientY - rect.top) * scaleY),
    };
  }

  function getColorAt(x, y) {
    if (x < 0 || y < 0 || x >= canvas.width || y >= canvas.height) return null;
    const pixel = ctx.getImageData(x, y, 1, 1).data;
    return { r: pixel[0], g: pixel[1], b: pixel[2], a: pixel[3] };
  }

  function rgbToHex(r, g, b) {
    return "#" + [r, g, b].map(c => c.toString(16).padStart(2, "0")).join("");
  }

  function showHoverPreview(clientX, clientY, color) {
    if (!color) {
      preview.style.display = "none";
      return;
    }
    preview.style.display = "block";
    preview.style.left = clientX + 10 + "px";
    preview.style.top = clientY + 10 + "px";
    const hex = rgbToHex(color.r, color.g, color.b);
    preview.textContent = hex;
    preview.style.backgroundColor = hex;
  }

  function addColor(hex) {
    // Controllo duplicati
    const exists = [...selectedColorsContainer.children].some(div => div.dataset.hex === hex);
    if (exists) return;

    const div = document.createElement("div");
    div.className = "color-box";
    div.style.backgroundColor = hex;
    div.dataset.hex = hex;
    selectedColorsContainer.appendChild(div);
  }

  function handlePointerMove(event) {
    const { x, y } = getCanvasCoordinates(event.clientX, event.clientY);
    const color = getColorAt(x, y);
    showHoverPreview(event.clientX, event.clientY, color);
  }

  function handlePointerClick(event) {
    const { x, y } = getCanvasCoordinates(event.clientX, event.clientY);
    const color = getColorAt(x, y);
    if (!color) return;
    const hex = rgbToHex(color.r, color.g, color.b);
    addColor(hex);
  }

  // Aggiorno colori box slider e loro valori
  function updateSlidersColors() {
    rColorBox.style.backgroundColor = `rgb(${rRange.value},0,0)`;
    gColorBox.style.backgroundColor = `rgb(0,${gRange.value},0)`;
    bColorBox.style.backgroundColor = `rgb(0,0,${bRange.value})`;
  }

  // Eventi
  canvas.addEventListener("pointermove", handlePointerMove);
  canvas.addEventListener("pointerdown", handlePointerClick);
  canvas.addEventListener("touchmove", e => {
    e.preventDefault(); // per evitare scrolling pagina
    if (e.touches.length === 1) {
      const touch = e.touches[0];
      handlePointerMove({clientX: touch.clientX, clientY: touch.clientY});
    }
  }, { passive: false });
  canvas.addEventListener("touchstart", e => {
    e.preventDefault();
    if (e.touches.length === 1) {
      const touch = e.touches[0];
      handlePointerClick({clientX: touch.clientX, clientY: touch.clientY});
    }
  }, { passive: false });

  rRange.addEventListener("input", () => {
    updateSlidersColors();
  });
  gRange.addEventListener("input", () => {
    updateSlidersColors();
  });
  bRange.addEventListener("input", () => {
    updateSlidersColors();
  });

  updateSlidersColors();
</script>
</body>
</html>
